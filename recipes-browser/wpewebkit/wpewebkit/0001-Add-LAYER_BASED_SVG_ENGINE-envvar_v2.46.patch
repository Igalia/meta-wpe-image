From 00cf045b0e615b5f425094fe0582d828550ec719 Mon Sep 17 00:00:00 2001
From: Pablo Saavedra <psaavedra@igalia.com>
Date: Wed, 24 May 2023 13:50:19 +0000
Subject: Add LAYER_BASED_SVG_ENGINE

... and LAYER_BASED_SVG_ENGINE_TOGGLER envvars
---
 .../UIProcess/API/glib/WebKitWebView.cpp      |  1 +
 Source/WebKit/WebProcess/WebPage/WebPage.cpp  | 21 +++++++++++++++++++
 2 files changed, 22 insertions(+)

diff --git a/Source/WebKit/UIProcess/API/glib/WebKitWebView.cpp b/Source/WebKit/UIProcess/API/glib/WebKitWebView.cpp
index f3af9a59..dea3b77f 100644
--- a/Source/WebKit/UIProcess/API/glib/WebKitWebView.cpp
+++ b/Source/WebKit/UIProcess/API/glib/WebKitWebView.cpp
@@ -3504,6 +3504,7 @@ void webkit_web_view_reload(WebKitWebView* webView)
 {
     g_return_if_fail(WEBKIT_IS_WEB_VIEW(webView));
 
+    webkitWebViewUpdateSettings(webView);
     getPage(webView).reload({ });
 }
 
diff --git a/Source/WebKit/WebProcess/WebPage/WebPage.cpp b/Source/WebKit/WebProcess/WebPage/WebPage.cpp
index 77826dab..a1f6ad8b 100644
--- a/Source/WebKit/WebProcess/WebPage/WebPage.cpp
+++ b/Source/WebKit/WebProcess/WebPage/WebPage.cpp
@@ -462,6 +462,8 @@
 #include <pal/cf/CoreTextSoftLink.h>
 #endif
 
+#include <filesystem>
+
 namespace WebKit {
 using namespace JSC;
 using namespace WebCore;
@@ -4659,6 +4661,25 @@ void WebPage::updatePreferences(const WebPreferencesStore& store)
 
     updateSettingsGenerated(store, settings);
 
+    const char* lbseEnabledToggler = getenv("LAYER_BASED_SVG_ENGINE_TOGGLER");
+    if (lbseEnabledToggler != NULL) {
+        if (std::filesystem::exists(std::filesystem::path {lbseEnabledToggler})) {
+            fprintf(stderr, "LAYER_BASED_SVG_ENGINE: 1 (activated by the %s toggler)\n", lbseEnabledToggler);
+            settings.setLayerBasedSVGEngineEnabled(true);
+        } else {
+            fprintf(stderr, "LAYER_BASED_SVG_ENGINE: 0 ('%s' the toggler doesn't exist)\n", lbseEnabledToggler);
+            settings.setLayerBasedSVGEngineEnabled(false);
+	}
+    } else {
+        const char* lbseEnabled = getenv("LAYER_BASED_SVG_ENGINE");
+        if (lbseEnabled != NULL && strcmp(lbseEnabled, "1") == 0) {
+            fprintf(stderr, "LAYER_BASED_SVG_ENGINE: '%s'\n", lbseEnabled);
+            settings.setLayerBasedSVGEngineEnabled(true);
+        } else {
+            settings.setLayerBasedSVGEngineEnabled(false);
+        }
+    }
+
 #if !PLATFORM(GTK) && !PLATFORM(WIN) && !PLATFORM(PLAYSTATION)
     if (!settings.acceleratedCompositingEnabled()) {
         WEBPAGE_RELEASE_LOG(Layers, "updatePreferences: acceleratedCompositingEnabled setting was false. WebKit cannot function in this mode; changing setting to true");
-- 
2.34.1

